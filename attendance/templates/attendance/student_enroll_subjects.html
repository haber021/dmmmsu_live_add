{% extends 'attendance/base.html' %}

{% block title %}Enroll in Subjects - Student Dashboard{% endblock %}

{% block extra_css %}
<style>
    .subject-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: 2px solid #dee2e6;
        min-height: 200px;
    }
    .subject-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .subject-card.enrolled {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    .subject-card.enrolled .card-header {
        background-color: #28a745;
        color: white;
    }
    .subject-card.pending {
        border-color: #ffc107;
        background-color: #fffbf0;
    }
    .subject-card.pending .card-header {
        background-color: #ffc107;
        color: #000;
    }
    .badge-enrolled {
        background-color: #28a745;
        color: white;
    }
    .badge-pending {
        background-color: #ffc107;
        color: #000;
    }
    .badge-not-enrolled {
        background-color: #6c757d;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <h2 class="mb-1">
        <i class="bi bi-book-plus"></i> Enroll in Subjects
    </h2>
    <p class="text-muted">Select subjects to enroll in for the current academic year and semester</p>
</div>

<!-- Academic Year and Semester Selector -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-calendar"></i> Academic Period</h5>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-5">
                <label for="academic_year" class="form-label">Academic Year</label>
                <input type="text" class="form-control" id="academic_year" name="academic_year" 
                       value="{{ academic_year }}" placeholder="e.g., 2025-2026">
            </div>
            <div class="col-md-5">
                <label for="semester" class="form-label">Semester</label>
                <select class="form-select" id="semester" name="semester">
                    <option value="1st Semester" {% if semester == '1st Semester' %}selected{% endif %}>1st Semester</option>
                    <option value="2nd Semester" {% if semester == '2nd Semester' %}selected{% endif %}>2nd Semester</option>
                    <option value="Summer" {% if semester == 'Summer' %}selected{% endif %}>Summer</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Filter
                </button>
            </div>
        </form>
        <div class="mt-3">
            <span class="badge bg-success">Enrolled: {{ enrolled_count }}</span>
            <span class="badge bg-secondary ms-2">Total Available: {{ total_count }}</span>
        </div>
    </div>
</div>

<!-- Subjects Grid -->
{% if subjects_data %}
<div class="row">
    {% for item in subjects_data %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card subject-card {% if item.is_enrolled %}enrolled{% elif item.is_pending %}pending{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>{{ item.subject.code }}</strong>
                <span class="badge {% if item.is_enrolled %}badge-enrolled{% elif item.is_pending %}badge-pending{% else %}badge-not-enrolled{% endif %}">
                    {% if item.is_enrolled %}
                        <i class="bi bi-check-circle"></i> Enrolled
                    {% elif item.is_pending %}
                        <i class="bi bi-clock"></i> Pending Approval
                    {% else %}
                        <i class="bi bi-circle"></i> Not Enrolled
                    {% endif %}
                </span>
            </div>
            <div class="card-body">
                <h6 class="card-title">{{ item.subject.name }}</h6>
                <p class="card-text text-muted mb-2">
                    <i class="bi bi-person"></i> <strong>Instructor:</strong> {% if item.subject.instructor %}{{ item.subject.instructor.name }}{% else %}â€”{% endif %}
                </p>
                {% if item.subject.schedules.all %}
                <p class="card-text text-muted mb-2">
                    <i class="bi bi-calendar-week"></i> <strong>Schedule:</strong> 
                    {% for schedule in item.subject.schedules.all %}
                        {% if not forloop.first %}, {% endif %}
                        {{ schedule.get_day_name }} ({{ schedule.time_start|time:"g:i A" }} - {{ schedule.time_end|time:"g:i A" }})
                    {% endfor %}
                </p>
                {% elif item.subject.schedule_days %}
                <p class="card-text text-muted mb-2">
                    <i class="bi bi-calendar-week"></i> <strong>Schedule:</strong> 
                    {{ item.subject.schedule_days }}
                    {% if item.subject.schedule_time_start and item.subject.schedule_time_end %}
                        ({{ item.subject.schedule_time_start|time:"g:i A" }} - {{ item.subject.schedule_time_end|time:"g:i A" }})
                    {% endif %}
                </p>
                {% endif %}
            </div>
            <div class="card-footer bg-transparent">
                {% if item.is_enrolled %}
                <form method="POST" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="subject_id" value="{{ item.subject.id }}">
                    <input type="hidden" name="academic_year" value="{{ academic_year }}">
                    <input type="hidden" name="semester" value="{{ semester }}">
                    <input type="hidden" name="action" value="unenroll">
                    <button type="submit" class="btn btn-danger btn-sm w-100 unenroll-btn"
                            data-message="Are you sure you want to unenroll from {{ item.subject.code }}?">
                        <i class="bi bi-x-circle"></i> Unenroll
                    </button>
                </form>
                {% elif item.is_pending %}
                <button type="button" class="btn btn-warning btn-sm w-100" disabled>
                    <i class="bi bi-clock"></i> Awaiting Adviser Approval
                </button>
                <small class="text-muted d-block text-center mt-2">
                    Your enrollment request is pending. Please wait for your adviser's confirmation.
                </small>
                {% else %}
                <form method="POST" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="subject_id" value="{{ item.subject.id }}">
                    <input type="hidden" name="academic_year" value="{{ academic_year }}">
                    <input type="hidden" name="semester" value="{{ semester }}">
                    <input type="hidden" name="action" value="enroll">
                    <button type="submit" class="btn btn-success btn-sm w-100">
                        <i class="bi bi-plus-circle"></i> Request Enrollment
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> No active subjects available at the moment. Please check back later.
</div>
{% endif %}

<!-- Back to Dashboard -->
<div class="mt-4">
    <a href="{% url 'student_dashboard' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle unenroll button confirmations
    document.querySelectorAll('.unenroll-btn').forEach(function(button) {
        const form = button.closest('form');
        const message = button.getAttribute('data-message');
        button.addEventListener('click', function(e) {
            e.preventDefault();
            customConfirm(message, function(confirmed) {
                if (confirmed) {
                    form.submit();
                }
            });
        });
    });
});
</script>
{% endblock %}

